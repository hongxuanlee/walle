/**
 * @author  ddchen chenjunyu@baidu.com
 */

module.exports = {
	create: function() {

		var routerRuleMap = {};

		var load = function(config) {
			loadRouterRules(config);
		}

		var getAction = function(module, requestParams) {
			var routerRule = getRouterRule(module.name);
			if (routerRule) {
				var routerKey = routerRule.match &&
					routerRule.match(requestParams.req, requestParams.res, requestParams.next);
				if (routerKey) {
					return routerRule.runAction;
				}
			}
			return null;
		}

		var getActionPath = function(module, requestParams) {
			var routerRule = getRouterRule(module.name);
			if (routerRule) {
				var routerKey = routerRule.match &&
					routerRule.match(requestParams.req, requestParams.res, requestParams.next);
				var routerConfig = require(module.router);
				return routerConfig[routerKey];
			}
			return null;
		}

		var loadRouterRules = function(config) {
			for (var moduleName in config) {
				var module = config[moduleName];
				if (!module) module = {};
				module["name"] = moduleName;
				var routerRule = loadRouterRule(module);
				routerRuleMap[moduleName] = routerRule;
			}
		}

		var loadRouterRule = function(module) {
			var routerConfig = require(module.router);
			var routerWay = module.routerWay;
			if (!routerWay) {
				return null;
			};
			var routerRule = require(module.routerWay);
			if (!routerRule) {
				return null;
			}
			var rule = routerRule(module.modulePath, routerConfig);
			return rule;
		}

		var getRouterRule = function(name) {
			return routerRuleMap[name];
		}

		return {
			load: load,
			getAction: getAction,
			getActionPath: getActionPath
		}
	}
}